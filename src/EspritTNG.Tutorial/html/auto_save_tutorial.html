<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: Auto Save</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="tutorial.css" rel="stylesheet" type="text/css" />
<link href="tab.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="tab.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Auto Save </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial introduces an Auto Save feature which allows to automatically and periodically save a project to a separate file, so that if something happens to the file, the user may revert to that previously saved state without losing too much work.</p>
<p>In the previous couple of tutorials we looked at Application and Document events. By combining some of those events and auto run procedures introduced in Tutorial: Introduction to Auto Run Procedures, we can create our own auto save tool. For example, suppose:</p>
<ul>
<li>We want ESPRIT to automatically save a copy of our file after we have completed a certain number of commands.</li>
<li>We want the saved copy to be in the same folder as the original file and have the same name, except instead of just the .esprit extension it will end with _Autosave.esprit</li>
<li>We want the auto save to reset whenever we open or start a new file.</li>
</ul>
<p>To do this, we can use either the AfterCommandRun or BeforeCommandRun events of the Application to count the number of commands. We should also use the AfterDocumentSave event of the Document to update the auto save filename in case the user saves the file to a new name or new folder location.</p>
<p>Define a class for these event procedures:</p>
<p><a class="anchor" id="AnchorGetAutoSaveName"></a> </p><div class="tab"> <div class="tablinks" onclick="openTab(event, &apos;CShsnippet&apos;, &apos;tabcontent1&apos;, &apos;tablinks&apos;)">C#</div> </div><div id="CShsnippet" class="tabcontent1"> <div class="fragment"><div class="line"> </div>
<div class="line">    <span class="keyword">class </span>AutoSaveHandler</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">private</span> readonly Esprit.Application _espritApplication;</div>
<div class="line">        <span class="keyword">private</span> <span class="keywordtype">int</span> _commandCounter;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">public</span> <span class="keywordtype">int</span> AutoSaveInterval;</div>
<div class="line">        <span class="keyword">public</span> <span class="keywordtype">string</span> AutoSaveName;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">public</span> AutoSaveHandler(Esprit.Application app)</div>
<div class="line">        {</div>
<div class="line">            _espritApplication = app;</div>
<div class="line">            AutoSaveInterval = 100;</div>
<div class="line">            _commandCounter = 0;</div>
<div class="line">            AutoSaveName = GetAutoSaveName();</div>
<div class="line"> </div>
<div class="line">            _espritApplication.Document.AfterDocumentSave += AfterDocumentSave;</div>
<div class="line">            _espritApplication.AfterCommandRun += AfterCommandRun;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">private</span> <span class="keywordtype">void</span> AfterCommandRun(<span class="keywordtype">int</span> nCmdId, <span class="keywordtype">int</span> nAuxId)</div>
<div class="line">        {</div>
<div class="line">            _commandCounter++;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (_commandCounter &gt;= AutoSaveInterval)</div>
<div class="line">            {</div>
<div class="line">                _espritApplication.Document.SaveCopyAs(AutoSaveName);</div>
<div class="line">                _commandCounter = 0;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">private</span> <span class="keywordtype">void</span> AfterDocumentSave()</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (_commandCounter &lt; AutoSaveInterval)</div>
<div class="line">            {</div>
<div class="line">                _commandCounter = 0;</div>
<div class="line">                AutoSaveName = GetAutoSaveName();</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">public</span> <span class="keywordtype">string</span> GetAutoSaveName()</div>
<div class="line">        {</div>
<div class="line">            var path = (_espritApplication.Document.FileName != <span class="keywordtype">string</span>.Empty)</div>
<div class="line">                ? Path.Combine(Path.GetDirectoryName(_espritApplication.Document.FileName), Path.GetFileNameWithoutExtension(_espritApplication.Document.FileName) + <span class="stringliteral">&quot;_AutoSave.esprit&quot;</span>)</div>
<div class="line">                : _espritApplication.TempDir + <span class="stringliteral">&quot;AutoSave.esprit&quot;</span>;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">return</span> path;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
</div><!-- fragment --></div><p>Now we can use this class in a standard code module to launch an object of our auto save class each time we open or start a new document.</p>
<div class="tab"> <div class="tablinks2" onclick="openTab(event, &apos;CShsnippet2&apos;, &apos;tabcontent2&apos;, &apos;tablinks2&apos;)">C#</div> </div><div id="CShsnippet2" class="tabcontent2"> <div class="fragment"><div class="line"> </div>
<div class="line">        <span class="keyword">private</span> AutoSaveHandler _testObject;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">public</span> <span class="keyword">override</span> <span class="keywordtype">void</span> Execute()</div>
<div class="line">        {</div>
<div class="line">            _testObject = <span class="keyword">new</span> AutoSaveHandler(EspritApplication)</div>
<div class="line">            {</div>
<div class="line">                AutoSaveInterval = 10</div>
<div class="line">            };</div>
<div class="line">        }</div>
<div class="line"> </div>
</div><!-- fragment --></div><p>Open a file and then click a command 10 times, like Fit. After the tenth time, you should see the processing bar at the bottom briefly come on to indicate that the file is being saved. Pick the File Open command. Do you see the _AutoSave.esprit file listed below the original?</p>
<p>Click New to start a new file, and try other commands, like creating geometry. Does the auto save wait until you have created 10 new geometry elements before it saves, or does it save sooner? It may save sooner because after each element is created, the graphics are redrawn, and that redraw counts as a command, too. When you start working on a real file, 10 commands will probably be too small of an interval in which to save. You can easily increase the interval as you get more experience with auto save. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<hr class="footer"/>
<script type="text/javascript" src="restoreTabs.js"></script>
</body>
</html>
