<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: Export Machine Setup Data And Load As Geometry</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="tutorial.css" rel="stylesheet" type="text/css" />
<link href="tab.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="tab.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Export Machine Setup Data And Load As Geometry </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial shows an example how to export and import machine setup data.</p>
<p>First you need to create a separate layer where all geometry are added:</p>
<div class="tab"> <div class="tablinks1" onclick="openTab(event, &apos;CShsnippet&apos;, &apos;tabcontent1&apos;, &apos;tablinks1&apos;)">C#</div> </div><div id="CShsnippet" class="tabcontent1"> <div class="fragment"><div class="line"> </div>
<div class="line">            var layer = LayerHelpers.GetEmptyLayer(Document, <span class="stringliteral">&quot;Exported Setup&quot;</span>);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (layer == <span class="keyword">null</span>)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            }</div>
<div class="line"> </div>
</div><!-- fragment --></div><p>The following function creates a new layer:</p>
<div class="tab"> <div class="tablinks2" onclick="openTab(event, &apos;CShsnippet2&apos;, &apos;tabcontent2&apos;, &apos;tablinks2&apos;)" style="display:active">C#</div> </div><div id="CShsnippet2" class="tabcontent2"> <div class="fragment"><div class="line"> </div>
<div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Esprit.Layer GetEmptyLayer(Esprit.Document document, <span class="keywordtype">string</span> name)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">foreach</span> (Esprit.Layer l in document.Layers)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (l.Name == name)</div>
<div class="line">                {</div>
<div class="line">                    document.Layers.Remove(name);</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            var layer = document.Layers.Add(name);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">return</span> layer;</div>
<div class="line">        }</div>
<div class="line"> </div>
</div><!-- fragment --></div><p>Now we can recursively scan all machine items</p>
<p><a class="anchor" id="AnchorExportMachineItemAndLoadAsGeometry"></a> </p><div class="tab"> <div class="tablinks3" onclick="openTab(event, &apos;CShsnippet3&apos;, &apos;tabcontent3&apos;, &apos;tablinks3&apos;)">C#</div> </div><div id="CShsnippet3" class="tabcontent3"> <div class="fragment"><div class="line"> </div>
<div class="line">            <span class="keywordflow">foreach</span> (Esprit.MachineItem machineItem in Document.InitialMachineSetup.MachineItems)</div>
<div class="line">            {</div>
<div class="line">                ExportMachineItemAndLoadAsGeometry(machineItem, layer);</div>
<div class="line">            }</div>
<div class="line"> </div>
</div><!-- fragment --> <div class="fragment"><div class="line"> </div>
<div class="line">        <span class="keyword">private</span> <span class="keywordtype">void</span> ExportMachineItemAndLoadAsGeometry(Esprit.MachineItem machineItem, Esprit.Layer targetLayer)</div>
<div class="line">        {</div>
<div class="line">            var stlPaths = ExportMachineItem(machineItem, targetLayer);</div>
<div class="line"> </div>
<div class="line">            ImportFile(machineItem, targetLayer, stlPaths);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">foreach</span> (Esprit.MachineItem item in machineItem.MachineItems)</div>
<div class="line">            {</div>
<div class="line">                ExportMachineItemAndLoadAsGeometry(item, targetLayer);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
</div><!-- fragment --></div><p>in order to:</p>
<ul>
<li>export STL models from the machine fixtures and workpieces in binary or text mode;</li>
<li>import the exported geometry in the part view;</li>
<li>retrieve position and orientation of a mounted fixture or workpiece on the machine.</li>
</ul>
<p><a class="anchor" id="AnchorExportMachineItem"></a> Export:</p>
<div class="tab"> <div class="tablinks4" onclick="openTab(event, &apos;CShsnippet4&apos;, &apos;tabcontent4&apos;, &apos;tablinks4&apos;)">C#</div> </div><div id="CShsnippet4" class="tabcontent4"> <div class="fragment"><div class="line"> </div>
<div class="line">        <span class="keyword">private</span> IEnumerable&lt;string&gt; ExportMachineItem(Esprit.MachineItem machineItem, Esprit.Layer targetLayer)</div>
<div class="line">        {</div>
<div class="line">            List&lt;string&gt; stlPaths = <span class="keyword">new</span> List&lt;string&gt;();</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">switch</span> (machineItem.MachineItemType)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">case</span> EspritConstants.espMachineItemType.espMachineItemTypeFixture:</div>
<div class="line">                    {</div>
<div class="line">                        var fixture = machineItem as Esprit.Fixture;</div>
<div class="line"> </div>
<div class="line">                        <span class="keywordtype">string</span> stlFilePath = Path.Combine(_stlPath, machineItem.Name + <span class="stringliteral">&quot;.STL&quot;</span>);</div>
<div class="line"> </div>
<div class="line">                        <span class="keywordflow">try</span></div>
<div class="line">                        {</div>
<div class="line">                            <span class="keywordflow">if</span> (_isBinaryMode)</div>
<div class="line">                            {</div>
<div class="line">                                fixture.ExportAsStlBinary(stlFilePath);</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">else</span></div>
<div class="line">                            {</div>
<div class="line">                                fixture.ExportAsStlText(stlFilePath);</div>
<div class="line">                            }</div>
<div class="line">                        }</div>
<div class="line">                        <span class="keywordflow">catch</span> (Exception)</div>
<div class="line">                        {</div>
<div class="line">                            EspritApplication.EventWindow.AddMessage(EspritConstants.espMessageType.espMessageTypeWarning, <span class="stringliteral">&quot;ExportMachineSetupDataTutorial&quot;</span>, <span class="stringliteral">&quot;Exception occured during fixture exporting&quot;</span>);</div>
<div class="line">                        }</div>
<div class="line"> </div>
<div class="line">                        stlPaths.Add(stlFilePath);</div>
<div class="line"> </div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">case</span> EspritConstants.espMachineItemType.espMachineItemTypeWorkpiece:</div>
<div class="line">                    {</div>
<div class="line">                        var workpiece = machineItem as Esprit.WorkpieceInstance;</div>
<div class="line">                        <span class="keywordtype">string</span> stlPartFilePath = Path.Combine(_stlPath, machineItem.Name + <span class="stringliteral">&quot;_part.STL&quot;</span>);</div>
<div class="line">                        <span class="keywordtype">string</span> stlStockFilePath = Path.Combine(_stlPath, machineItem.Name + <span class="stringliteral">&quot;_stock.STL&quot;</span>);</div>
<div class="line"> </div>
<div class="line">                        <span class="keywordflow">try</span></div>
<div class="line">                        {</div>
<div class="line">                            <span class="keywordflow">if</span> (_isBinaryMode)</div>
<div class="line">                            {</div>
<div class="line">                                workpiece.ExportPartAsStlBinary(stlPartFilePath);</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">else</span></div>
<div class="line">                            {</div>
<div class="line">                                workpiece.ExportPartAsStlText(stlPartFilePath);</div>
<div class="line">                            }</div>
<div class="line">                        }</div>
<div class="line">                        <span class="keywordflow">catch</span>(Exception)</div>
<div class="line">                        {</div>
<div class="line">                            EspritApplication.EventWindow.AddMessage(EspritConstants.espMessageType.espMessageTypeWarning, <span class="stringliteral">&quot;ExportMachineSetupDataTutorial&quot;</span>, <span class="stringliteral">&quot;Exception occured during workpiece part exporting, probably it does not exist in GDML&quot;</span>);</div>
<div class="line">                        }</div>
<div class="line"> </div>
<div class="line">                        <span class="keywordflow">try</span></div>
<div class="line">                        {</div>
<div class="line">                            <span class="keywordflow">if</span> (_isBinaryMode)</div>
<div class="line">                            {</div>
<div class="line">                                workpiece.ExportStockAsStlBinary(stlStockFilePath);</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">else</span></div>
<div class="line">                            {</div>
<div class="line">                                workpiece.ExportStockAsStlText(stlStockFilePath);</div>
<div class="line">                            }</div>
<div class="line">                        }</div>
<div class="line">                        <span class="keywordflow">catch</span> (Exception)</div>
<div class="line">                        {</div>
<div class="line">                            EspritApplication.EventWindow.AddMessage(EspritConstants.espMessageType.espMessageTypeWarning, <span class="stringliteral">&quot;ExportMachineSetupDataTutorial&quot;</span>, <span class="stringliteral">&quot;Exception occured during workpiece stock exporting, probably it does not exist in GDML&quot;</span>);</div>
<div class="line">                        }</div>
<div class="line"> </div>
<div class="line">                        stlPaths.Add(stlPartFilePath);</div>
<div class="line">                        stlPaths.Add(stlStockFilePath);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">return</span> stlPaths;</div>
<div class="line">        }</div>
<div class="line"> </div>
</div><!-- fragment --></div><p>STL file is exported in a coordinate system corresponding to the root node of the component.</p>
<p><a class="anchor" id="AnchorImportFile"></a> Import:</p>
<div class="tab"> <div class="tablinks5" onclick="openTab(event, &apos;CShsnippet5&apos;, &apos;tabcontent5&apos;, &apos;tablinks5&apos;)">C#</div> </div><div id="CShsnippet5" class="tabcontent5"> <div class="fragment"><div class="line"> </div>
<div class="line">        <span class="keyword">private</span> <span class="keywordtype">void</span> ImportFile(Esprit.MachineItem machineItem, Esprit.Layer targetLayer, IEnumerable&lt;string&gt; stlFilePaths)</div>
<div class="line">        {</div>
<div class="line">            var tmpLayerName = <span class="stringliteral">&quot;TempLayer&quot;</span>;</div>
<div class="line">            var tmpLayer = Document.Layers.Add(tmpLayerName);</div>
<div class="line">            Document.ActiveLayer = tmpLayer;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">foreach</span> (var path <span class="keywordflow">in</span> stlFilePaths)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (File.Exists(path))</div>
<div class="line">                {</div>
<div class="line">                    Document.MergeFile(path);</div>
<div class="line">                }</div>
<div class="line">                </div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            ApplyTransformation(machineItem, targetLayer, tmpLayerName);</div>
<div class="line">            Document.Layers.Remove(tmpLayerName);</div>
<div class="line">        }</div>
<div class="line"> </div>
</div><!-- fragment --></div><p><a class="anchor" id="AnchorApplyTransformation"></a> Retrieving position and orientation:</p>
<div class="tab"> <div class="tablinks6" onclick="openTab(event, &apos;CShsnippet6&apos;, &apos;tabcontent6&apos;, &apos;tablinks6&apos;)">C#</div> </div><div id="CShsnippet6" class="tabcontent6"> <div class="fragment"><div class="line"> </div>
<div class="line">        <span class="keyword">private</span> <span class="keywordtype">void</span> ApplyTransformation(Esprit.MachineItem machineItem, Esprit.Layer targetLayer, <span class="keywordtype">string</span> tmpLayerName)</div>
<div class="line">        {</div>
<div class="line">            var selectionSet = SelectionSetHelper.GetOrAddSelectionSet(Document.SelectionSets, <span class="stringliteral">&quot;Temp&quot;</span>);</div>
<div class="line">            selectionSet.RemoveAll();</div>
<div class="line"> </div>
<div class="line">            var tmpPlaneName = <span class="stringliteral">&quot;TempPlane&quot;</span>;</div>
<div class="line">            EspritGeometryBase.IComMatrix mat = machineItem.CumulativeTransformation;</div>
<div class="line">            Esprit.Plane plane = PlaneHelper.AddUniquePlane(Document.Planes, tmpPlaneName);</div>
<div class="line">            plane.X = mat.P.X;</div>
<div class="line">            plane.Y = mat.P.Y;</div>
<div class="line">            plane.Z = mat.P.Z;</div>
<div class="line">            plane.Ux = mat.U.X;</div>
<div class="line">            plane.Uy = mat.U.Y;</div>
<div class="line">            plane.Uz = mat.U.Z;</div>
<div class="line">            plane.Vx = mat.V.X;</div>
<div class="line">            plane.Vy = mat.V.Y;</div>
<div class="line">            plane.Vz = mat.V.Z;</div>
<div class="line">            plane.Wx = mat.W.X;</div>
<div class="line">            plane.Wy = mat.W.Y;</div>
<div class="line">            plane.Wz = mat.W.Z;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">foreach</span> (Esprit.IGraphicObject graphicObject in Document.GraphicsCollection)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (graphicObject.Layer.Name == tmpLayerName)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">try</span></div>
<div class="line">                    {</div>
<div class="line">                        selectionSet.Add(graphicObject);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">catch</span>(Exception)</div>
<div class="line">                    {</div>
<div class="line">                        EspritApplication.EventWindow.AddMessage(EspritConstants.espMessageType.espMessageTypeWarning, <span class="stringliteral">&quot;ExportMachineSetupDataTutorial&quot;</span>, <span class="stringliteral">&quot;Exception occured - failed to add graphic object to Esprit.SetectionSet&quot;</span>);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            selectionSet.AlignPlane(plane, EspritConstants.espAlignPlaneMode.espAlignPlaneFromGlobalXYZ, 0);</div>
<div class="line">            selectionSet.ChangeLayer(targetLayer, 0);</div>
<div class="line"> </div>
<div class="line">            Document.Planes.Remove(plane.Name);</div>
<div class="line">        }</div>
<div class="line"> </div>
</div><!-- fragment --> <div class="fragment"><div class="line"> </div>
<div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Esprit.Plane AddUniquePlane(Esprit.IPlanes planes, <span class="keywordtype">string</span> baseName)</div>
<div class="line">        {</div>
<div class="line">            var suffix = 0;</div>
<div class="line">            <span class="keywordflow">foreach</span> (Esprit.Plane plane in planes)</div>
<div class="line">            {</div>
<div class="line">                var planeName = plane.Name;</div>
<div class="line">                <span class="keywordflow">if</span> (planeName.Length &gt; baseName.Length &amp;&amp; planeName.StartsWith(baseName) &amp;&amp; planeName[baseName.Length] == <span class="charliteral">&#39;_&#39;</span>)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">if</span> (<span class="keywordtype">int</span>.TryParse(planeName.Substring(baseName.Length + 1), out var index))</div>
<div class="line">                    {</div>
<div class="line">                        <span class="keywordflow">if</span> (index &gt;= suffix)</div>
<div class="line">                        {</div>
<div class="line">                            suffix = index + 1;</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            var name = $<span class="stringliteral">&quot;{baseName}_{suffix}&quot;</span>;</div>
<div class="line">            <span class="keywordflow">return</span> planes.Add(name);</div>
<div class="line">        }</div>
<div class="line"> </div>
</div><!-- fragment --></div><p>After running the code, all fixtures and the workpiece part and stock geometry are visible in part view. Delete "Exported Setup" layer if you need to delete all the imported geometry. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<hr class="footer"/>
<script type="text/javascript" src="restoreTabs.js"></script>
</body>
</html>
